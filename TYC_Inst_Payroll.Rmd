---
title: "TYC Payroll PDF Creation"
output: html_notebook
---

# Initialization

```{r}
library(tidyverse)
library(shiny)
library(quarto)
library(googledrive)
library(googlesheets4)
```

# Get parent id

```{r get-parent-id, include=FALSE}
# Authenticate with Google Sheets
gs4_auth(email = "andymaffei@gmail.com")

# Specify the ID of the parent folder
parent_id <- "1NGyvhDrOaOrXI-kKMb29z0KBs3wX6qRl"

```

# Get the payrate and instructor tables from Google Sheets

```{r get-payrate-instructor-table, include=FALSE}

# Specify the file and folder names
payrate_file_name <- "tyc-payrates"
instructor_file_name <- "tyc-instructors"
pdf_folder_name <- "instructor_pdfs"
instructors_attending_name <- "instructors_attending_feb2024"

# Find the sheets and folder
payrate_file <- drive_ls(path = as_id(parent_id)) |>
  filter(name == payrate_file_name)
instructor_file <- drive_ls(path = as_id(parent_id)) |>
  filter(name == instructor_file_name)

# read the payroll sheet into a tibble
payrate_tbl <- read_sheet(payrate_file$id) |>
  rename(
    hourly_pay_rate = `WL Hourly Payrate`,
    pp7 = PP7,
    cap = Cap,
    base0 = `Base 0`,
    base1 = `Base 1 Plus`)

# read the instructor sheet into a tibble
instructor_tbl <- read_sheet(instructor_file$id) |>
  rename(
    name = Name,
    instructor_pay_rate = 'Hourly Pay Rate',
    anniversary = 'Anniversary Date'
  )

```

# Get parent, month_folder, abd PDF folder IDs from Google Drive

```{r get-parent-id-and-month_folder, include=FALSE}
# Authenticate with Google Drive
drive_auth(email = "andymaffei@gmail.com")

# Specify the URL of the parent directory
parent_url <- "https://drive.google.com/drive/folders/1NGyvhDrOaOrXI-kKMb29z0KBs3wX6qRl"

# Extract the ID from the URL
parent_id <- gsub(".*/folders/(.*)$", "\\1", parent_url)

# Prompt for year and month
year <- readline(prompt="Enter the year: ")
month <- readline(prompt="Enter the month: ")

# Construct the folder and file names
month_folder_name <- paste(year, month, sep = "-")

# Find the month_folder ID
month_folder_id <- drive_ls(path = as_id(parent_id)) |> 
  filter(name == month_folder_name) |>
  select(id)

# Find the pdf folder ID
pdffolder_id <- drive_ls(path = month_folder_id$id) |> 
  filter(name == pdf_folder_name) |>
  select(id)

```

# Generate payrole tibble from payroll CSV and clean it up

```{r get-data-files, include=FALSE}
# Get the payroll file name

file_name <- paste("tyc_wlpayroll", "-", paste(year, month, sep = ""), ".csv", sep = "")

# Find the csv file
file <- drive_ls(path = month_folder_id$id) |> 
  filter(name == file_name)

# q: do we need to download the file?
# a: yes, because we need to read it into a tibble
# q: how can we download the file to a temporary directory?



# Download the file
drive_download(file$id, overwrite = TRUE)

# Read the file into a tibble
services_held <- read_csv(
  file_name,
  col_types = cols(
    s_staff.text_fullname = col_character(),
    Client = col_skip(),
    Email = col_skip(),
    Phone = col_skip(),
    `Member ID` = col_skip(),
    Day = col_character(),
    Time = col_character(),
    # Day = col_date(format = "%b %d, %Y"),
    # Time = col_time(format = "%I:%M%p"),
    `Service Name.` = col_character(),
    `Service Type` = col_character(),
    `Commission Sales` = col_skip(),
    Booked = col_integer(),
    Attended = col_integer(),
    `No shows` = col_skip(),
    `Late Cancels` = col_integer(),
    `Base Rate` = col_skip(),
    Bonus = col_skip(),
    Total = col_character(),
    `Tip Amount` = col_skip(),
    `Hourly Pay Rate` = col_character(),
  )
)

# Cleanup the data

# turn dollar amout into a number


services_held <- services_held |>
    mutate(wl_calc_pay = parse_number(Total)) |>
    mutate(short_service = ifelse(
      grepl("^ *[Ii][Nn] [Ss][Tt][Uu][Dd][Ii][Oo] *", `Service Name.`),
      gsub("^ *[Ii][Nn] [Ss][Tt][Uu][Dd][Ii][Oo] *", "",`Service Name.`),
      gsub("^ *Virtual via Zoom *", "", `Service Name.`))) |>
    rename(instructor = s_staff.text_fullname,
           date = Day,
           time = Time,
           service_name = `Service Name.`,
           service_type = `Service Type`,
           bk  = Booked,
           at = Attended,
           lc = `Late Cancels`,
           total = Total,
           hourly_pay_rate = `Hourly Pay Rate`
           )

```

# Read the instructors attending sheet and clean it up

```{r read-instructors-attending-csv, include=FALSE}
file_name <- "instructors_attending_empty.csv"
# Find the csv file
file <- drive_ls(path = month_folder_id$id) |> 
  filter(name == file_name)

# Download the file
drive_download(file$id, overwrite = TRUE)

# Read the instructors-attending csv into a tibble
instructors_attending <- read_csv(
  file_name,
  col_types = cols(
    Service = col_character(),
    Date = col_character(),
    Time = col_character(),
    Staff = col_character(),
    Attending = col_integer()
  )) |>
  # Change time so that instead of a range only the start time is used
  mutate(Time = gsub(" - .*", "", Time)) |>
  rename(
    service = Service,
    date = Date,
    time = Time,
    staff = Staff,
    attending = Attending
  )
```

# Split the payroll table into studio and virtual and then join

```{r add-virtual-students-to-studio-students, include=FALSE}

# Split the table based on Service Names starting with "IN STUDIO"
s_services <- services_held |>
  filter(grepl("[Ii][Nn] [Ss][Tt][Uu][Dd][Ii][Oo]", service_name))

# Split the table based on Service Names starting with "Virtual via Zoom"
v_services <- services_held |>
  filter(grepl("Virtual via Zoom", service_name))

# Join columns from v_services to s_services and calculate attendees
# changing NAs to 0
combined_sv <- s_services |>
  left_join(v_services, by = c(
    "instructor", "date", "time", "service_type" ),
    relationship = "one-to-one",
    suffix = c(".s",".v"))

# Generate a table of rows in v_services that did not match rows in s_services
v_services_not_in_s_services <- v_services |>
  anti_join(s_services, by = c(
    "instructor", "date", "time", "service_type", "short_service")) |>
  rename(
    service_name.v = service_name,
    bk.v = bk,
    at.v = at,
    lc.v = lc,
    total.v = total,
    hourly_pay_rate.v = hourly_pay_rate,
    wl_calc_pay.v = wl_calc_pay,
    short_service.v = short_service
  )
  
# Append these rows to combined_sv
combined_sv <- bind_rows(combined_sv, v_services_not_in_s_services)

# Change NAs to 0 for people counts
combined_sv <- combined_sv |>
  mutate(bk.s = ifelse(is.na(bk.s), 0, bk.s)) |>
  mutate(at.s = ifelse(is.na(at.s), 0, at.s)) |>
  mutate(lc.s = ifelse(is.na(lc.s), 0, lc.s)) |>
  mutate(bk.v = ifelse(is.na(bk.v), 0, bk.v)) |>
  mutate(at.v = ifelse(is.na(at.v), 0, at.v)) |>
  mutate(lc.v = ifelse(is.na(lc.v), 0, lc.v)) |>
  mutate(wl_calc_pay.s = ifelse(is.na(wl_calc_pay.s), 0, wl_calc_pay.s)) |>
  mutate(wl_calc_pay.v = ifelse(is.na(wl_calc_pay.v), 0, wl_calc_pay.v)) |>
  mutate(total_attendees = at.s + lc.s + at.v)

```

# Add pay columns to combined_sv

```{r add-pay-columns, include=FALSE}

# Add the pay columns

# Add base0, base1, pp7, and cap columns to combined_sv by
# joining with payrate_tbl


combined_sv_w_pay <- combined_sv |>
  left_join(payrate_tbl, by = c("hourly_pay_rate.s" = "hourly_pay_rate")) |>
  rename(
    pp7 = pp7,
    cap = cap,
    base0 = base0,
    base1 = base1
  )

# Add attending column to combined_sv_w_pay by joining with instructors_attending
# and changing NAs to 0 for attending counts.

combined_sv_w_pay <- combined_sv_w_pay |>
  left_join(instructors_attending, by = c("instructor" = "staff",
                                          "date" = "date",
                                          "time" = "time")) |>
  mutate(attending = ifelse(is.na(attending), 0, attending)) |>
  rename (ex = attending) |>
  select (-service)

# Subtract ex from total_attendees to get the number of students
# and place it in the total_attendees column
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(total_attendees = total_attendees - ex)
```


```{r add-pay-columns-2, include=FALSE}

# Add the base_pay column for classes
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(base_pay = ifelse(service_type == "Classes" & total_attendees == 0,
                           base0,
                           base1))

# Add the bonus_pay column for classes
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(bonus_pay = ifelse(service_type == "Classes" & total_attendees - 6 > 0,
                            (total_attendees - 6) * pp7,
                            0))

# Calculate the final_pay column for classes
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(final_pay = ifelse(service_type == "Classes",
                            base_pay + bonus_pay,
                            0))

# Cap the final_pay column for classes
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(final_pay = ifelse(service_type == "Classes" & final_pay > cap,
                            cap,
                            final_pay))

# Add the final_pay column for events
# Note that WL has already calculated the pay for events using 70%
combined_sv_w_pay <- combined_sv_w_pay |>
  mutate(final_pay = ifelse(service_type == "Events",
                            (wl_calc_pay.s + wl_calc_pay.v) * 1.0,
                            final_pay))
  
```

# Create a new tibble with the columns we want

```{r create-new-tibble, include=FALSE}
services_data_all <- combined_sv_w_pay |>
  select(instructor, date, time, short_service.s, service_type, 
         at.s, lc.s, at.v, ex, total_attendees, hourly_pay_rate.s, final_pay) |>
  rename(
    short_service = short_service.s,
    hourly_pay_rate = hourly_pay_rate.s,
    total = total_attendees,
    stype = service_type)

```

# Create a summary table of services_data_all by instructor

```{r create-summary-table, include=FALSE}
# Create a summary table of services_data_all by instructor
services_data_summary <- services_data_all |>
  group_by(instructor) |>
  summarize(
    classes = sum(stype == "Classes"),
    participants = sum(total),
    pay = sum(final_pay),
  )
```

# Write CSV files for all_service_data and services_data_summary 
# and upload to google drive

```{r write-csvs, eval=TRUE, include=FALSE}
# Write CSV files for all_services_data
service_data_csv <- paste("service_data-",year,month,".csv", sep="")
instructor_summary_csv <- paste("instructor_data-",year,month,".csv", sep="")

write_csv(services_data_all, service_data_csv)
write_csv(services_data_summary, instructor_summary_csv)

# Upload it to google drive
drive_upload(service_data_csv,
             path = month_folder_id$id,
             overwrite = TRUE)
drive_upload(instructor_summary_csv,
             path = month_folder_id$id,
             overwrite = TRUE)

```

# Create PDFs for each instructor

```{r eval=TRUE, include=FALSE}
unique_instructors <- unique(combined_sv_w_pay$instructor)

for (i in 1:NROW(unique_instructors)) {
  # grab instructor name
    instructor_name <- unique_instructors[i] # Each row is a unique instructor
    
  # get instructor payinfo by looking in instructor_tbl by instructor_name
   instructor_payrate <- instructor_tbl |>
      filter(name == instructor_name) |>
      select(instructor_pay_rate)
    
  # get payrate data by looking in payrate_tbl by instructor
    payrate_data <- payrate_tbl |>
      filter(hourly_pay_rate == instructor_payrate$instructor_pay_rate) |>
      select(hourly_pay_rate, pp7, cap, base0, base1)
    
  # get service data by looking in combined_sv_w_pay by instructor
    service_data <- services_data_all |>
      filter(instructor == instructor_name)
    
  # render the template
    quarto::quarto_render(
        input = "template.qmd",
        output_file = paste0("payroll-", instructor_name, ".pdf"),
        execute_params = list(
            iname = instructor_name,
            pdata = jsonlite::toJSON(payrate_data),
            cdata = jsonlite::toJSON(service_data) # Serialize the data frame
        )
    )
    
  # upload the pdf to the pdf folder
    drive_upload(paste0("payroll-", instructor_name, ".pdf"),
                 path = pdffolder_id$id,
                 overwrite = TRUE)
}
```
